<%configSonos =  JSON.parse(fs.readFileSync('plugins/sonos/configSonosPerso.prop','utf8'));devices = JSON.parse(fs.readFileSync('plugins/sonos/devices.tmp','utf8'));%><html>	<body>		<script>	$(document).ready(function() {		$('#monForm').on('submit', function() {			$.ajax({			  type: "POST",			  url: '/sarah/sonos?actionSonos=saveConfig',			  data: $(this).serialize(),			  success: function() {				  alert('Paramètres sauvegardés. Merci de redemarrer votre serveur NodeJS.');			  }			});			return false;		});				$("#plugin-menu .plugin-nav a").click(function () {            $("#plugin-menu .content > ul").hide();            $("#plugin-menu .plugin-nav ul li").removeClass("active");            $(this).parent().addClass("active");            $("#" + $(this).data("toggle")).show();            return false;        });				limitSonos();				/* On récupère en JS la config */		configSonos =<%-JSON.stringify(configSonos)%>	});			function limitSonos() {		$('.enceintes > option').each(function() {			$(this).removeAttr('disabled');		});				$('.enceintes > option:selected').each(function() {			roomName = $(this).val();			$('.enceintes > option:not(.enceintes > option:selected)').each(function() {				if (roomName == $(this).val() && $(this).val() != '...') {					$(this).attr('disabled', 'disabled');				}			});		});	}		/*	* Vérifie que le nom de la Sonos n'existe pas	* Return true nom trouvé	*/	function checkIfnameExist(sonosName)	{		for (var key in configSonos.equipements)		{			if (sonosName == key)				return true;		}		return false;	}		function createEquipements() {		nomEquipement = prompt('Quel est le nom du client Sarah ?');		nomEnceinte = prompt('Quel est le nom (unique) de l\'enceinte ?');		if(checkIfnameExist(nomEnceinte))			alert("Le nom de l\'enceinte existe. Recommencez!");		if (!nomEquipement != null && nomEquipement != "" && nomEnceinte != null && nomEnceinte != "") {			$('#tableauEquipements > tbody:last').append('<tr id="ligne_'+nomEquipement+'_'+nomEnceinte+'">											<td align="center">'+nomEquipement+'</td>											<td align="center">'+nomEnceinte+'</td>											<td align="center">												<input type="hidden" name="equipements['+nomEquipement+']['+nomEnceinte+'][mac]" value="" id="equipementsmac'+nomEquipement+'_'+nomEnceinte+'" />												<input type="hidden" name="equipements['+nomEquipement+']['+nomEnceinte+'][ip]" value="" id="equipementsip'+nomEquipement+'_'+nomEnceinte+'" />												<select class="enceintes" onChange="$(\'#equipementsmac'+nomEquipement+'_'+nomEnceinte+'\').val($(\'option:selected\', this).attr(\'mac\'));$(\'#equipementsip'+nomEquipement+'_'+nomEnceinte+'\').val($(\'option:selected\', this).attr(\'ip\'));limitSonos();">												<option mac="" ip="">...</option>												<%												for (var deviceIndex in devices){ %>																<option mac="<%= devices[deviceIndex].mac %>" ip="<%= devices[deviceIndex].ip %>"><%= devices[deviceIndex].name %></option>													<%												}												%>											</select>											</td>											<td align="center">												<input type="hidden" name="equipements['+nomEquipement+']['+nomEnceinte+'][vocalisation]" id="equipementvcl'+nomEquipement+'_'+nomEnceinte+'" value="1" />												<input type="checkbox" value="1" checked="checked">											</td>											<td><img src="./assets/sonos/images/del.png" alt="Supprimer cet équipement" title="Supprimer cet équipement" style="cursor:pointer" onClick="if (confirm(\'Etes vous sûr de vouloir supprimer cet équipement ?\')) { $(\'#ligne_'+nomEquipement+'_'+nomEnceinte+'\').remove(); }" /></td>										</tr>');				}				limitSonos();				return false;	}	</script>	Version : 2.1 - <b>Compatible uniquement sur la version Windows du serveur SARAH</b><br>	 <br>	<div id="plugin-menu" class="row-fluid">		<!-- Navigation -->		<div class="span3 well plugin-nav">			<ul class="nav nav-list">				<li><a href="#" data-toggle="plugin-doc">Documentation</a></li>				<li><a href="#" data-toggle="plugin-config">Configuration</a></li>				<li><a href="#" data-toggle="plugin-errors">Erreurs</a></li>				<li><a href="#" data-toggle="plugin-changelog">Changelog</a></li>			</ul>		</div>		<!-- Content -->		<div class="span9 content">			<ul class="unstyled" id="plugin-doc">				Ce plugin permet de contrôler des périphériques SONOS. Il vous permet aussi de rediriger les TTS à travers votre système SONOS. Il vous faut dans un premier temps récupèrer l'IP et l'adresse MAC de vos équipements SONOS sur le réseau.				 <br/><br/>				Les actions suivantes sont disponibles :<br/>				<ul>					<li>lecture/pause</li>					<li>musique suivante/précédente (next)</li>					<li>augmenter/baisser le volume</li>					<li>synchroniser des pièces</li>				</ul>				<br/><br/>				Dans l'application SONOS sur un PC, allez dans "Aide" puis "A propos de mon système SONOS". Vous y verrez ici l'ensemble des périphériques.<br/>				<img border=0 width=400 height=500 src="./assets/sonos/images/Sonos_IP.png"><br/><br/>				Récupèrer les IP et renseignez les dans la configuration.<br/>				<br/>				Attention à bien faire correspondre le lieu du fichier "sonos.xml" (variable : out.action.idPiece='salon') avec la variable présente dans le fichier de configuration (ip)				<br/><br/>				Vous pouvez commander vos sonos en indiquant à chaque fois l'action et le lieu. Sarah vous répondra dans le lieu en question<br/>				Exemple :<br/>				Sarah --- Action --- lieu<br/>				Sarah --- Allume la musique --- dans le salon<br/>			</ul>			<ul class="unstyled" id="plugin-config" style="display: none;">				<form id="monForm" method="post" action="/sarah/sonos/?actionSonos=saveConfig">					<table class="table table-striped table-hover">						<caption>Paramètre du plugin</caption>						<thead>							<tr>								<td><b>Paramètre</b></td>								<td><b>Valeur</b></td>								<td class="commentaires"><b>Commentaire</b></td>							</tr>						</thead>						<tbody>							<tr>								<td>Enceintes</td>								<td>								<table id="tableauEquipements" border=1>								<thead>									<tr>										<td align="center">Client&nbsp;Sarah</td>										<td align="center">Nom</td>										<td align="center">Enceinte&nbsp;Sonos</td>										<td align="center">Vocalisation</td>										<td></td>									</tr>								</thead>								<tbody>							<% 							for (var key in configSonos.equipements){								for (var name in configSonos.equipements[key]){%>									<tr id="ligne_<%= key %>_<%= name %>">										<td align="center"><%= key %></td>										<td align="center"><%= name %></td>										<td align="center">											<input type="hidden" name="equipements[<%= key %>][<%= name %>][mac]" id="equipementsmac<%= key %>_<%= name %>" value="<%= configSonos.equipements[key][name].mac %>" />											<input type="hidden" name="equipements[<%= key %>][<%= name %>][ip]" id="equipementsip<%= key %>_<%= name %>" value="<%= configSonos.equipements[key][name].ip %>" />											<select class="enceintes" onChange="$('#equipementsmac<%= key %>_<%= name %>').val($('option:selected', this).attr('mac'));$('#equipementsip<%= key %>_<%= name %>').val($('option:selected', this).attr('ip'));limitSonos();">												<option mac="" ip="">...</option>												<%												for (var deviceIndex in devices){ %>																<option <% if (configSonos.equipements[key][name].mac == devices[deviceIndex].mac){ %>selected<% } %> mac="<%= devices[deviceIndex].mac %>" ip="<%= devices[deviceIndex].ip %>"><%= devices[deviceIndex].name %></option>													<%												}												%>											</select>											</td>										<td align="center">											<input type="hidden" name="equipements[<%= key %>][<%= name %>][vocalisation]" id="equipementvcl<%= key %>_<%= name %>" value="<%= configSonos.equipements[key][name].vocalisation %>" />											<input type="checkbox" value="<%= configSonos.equipements[key][name].vocalisation %>" 											<% if (configSonos.equipements[key][name].vocalisation == 1) { %>checked="checked<% } %>"											onclick="$('#equipementvcl<%= key %>_<%= name %>').attr('value', this.checked ? 1 : 0)">										</td>										<td><img src="./assets/sonos/images/del.png" alt="Supprimer cet équipement" title="Supprimer cet équipement" style="cursor:pointer" onClick="if (confirm('Etes vous sûr de vouloir supprimer cet équipement ?')) { $('#ligne_<%= key %>_<%= name %>').remove(); }" /></td>									</tr>									<%								}							}							%>								</tbody>								</table>								<br />								<a href="#" onClick="return createEquipements();"><img src="./assets/sonos/images/add.png" alt="Ajouter un équipement" style="cursor:pointer" onClick="" /> Ajouter un équipement</a>								</td>								<td class="commentaires">Configuration des équipements SONOS									<br /><br />									Les noms des clients doivent être strictement identique au nom du client SARAH. Vous trouverez ce nom dans le fichier custom.ini (client=).								</td>							</tr>							<tr>								<td>Volume des annonces</td>								<td><input type="number" name="volumeAnnonce" min="0" max="100" value="<%= configSonos.volumeAnnonce %>" /></td>								<td class="commentaires">Permet de définir le volume quand Sarah parle.</td>							</tr>							<tr>								<td>Palier volume</td>								<td><input type="number" name="volumePalier" min="0" max="100" value="<%= configSonos.volumePalier %>" /></td>								<td class="commentaires">Permet de définir le palier quand Sarah monte ou baisse le volume.</td>							</tr>							<tr>								<td>Radio</td>								<td><input type="text" name="defaultRadio" value="<%= configSonos.defaultRadio %>" /></td>								<td class="commentaires">Permet de définir la radio par défaut que Sarah peut lancer.									<br />									Google Musique (j'ai de la chance) : x-sonosapi-radio:Ivvo_gGiNo8?sid=151								</td>							</tr>							<tr>								<td>Exporter les voix</td>								<td>									<select name="exportAllVoice">										<option value="1" <% if (configSonos.exportAllVoice == 1){ %>selected<% } %>>Oui</option>										<option value="0" <% if (configSonos.exportAllVoice == 0){ %>selected<% } %>>Non</option>									</select>								</td>								<td class="commentaires">									<ul>										<li> Non : Sarah ne parle qu'à travers vos enceintes habituelles</li>										<li> Oui : Sarah ne parlera qu'à travers le système SONOS, même pour les autres plugins. Ce paramétrage active le multiroom.</li>									</ul>								</td>							</tr>						</tbody>					</table>									<div align="center"><input type="submit" /></div>				</form>			</ul>			<ul class="unstyled" id="plugin-errors" style="display: none;">				<h1>Sarah répond en anglais à travers les SONOS</h1>				<pre>				1.  Download RSSolo4French.zip     http://faq.sodeasoft.com/dwn/RSSolo4French.zip<br />				2.  Décompacter<br />				3.  Installer<br />				4. Aller à : C:\Windows\SysWOW64\Speech\SpeechUX<br />				5. Double clic sur le fichier sapi.cpl (faite un raccourci bureau)<br />				6.  Selectioner la voix  ScanSoft Virginie_Dri40_16kHz<br />				7. Utiliser la phrase suivante: "Merci sarah" :-)<br />				8.  Cliquer: Tester la voix<br />				9.  Cliquer: Appliquer<br />				10.  Cliquer:OK﻿<br />				</pre>			</ul>			<ul class="unstyled" id="plugin-changelog" style="display: none;">				<h1>TODO</h1>				<div class="span3 well plugin-nav">					-listing radio<br / >- vocalisation sur plusieurs sonos				</div>				<h1>V2.1</h1>				<div class="span3 well plugin-nav">					- Correction du bug qui empechait Sarah de parler jusqu'au bout dans certains longs TTS.<br />					- Correction et amélioration du .XML<br />					- Correction du bug qui empechait une radio google music de se relancer correctement après le TTS.<br />					- Correction des synchronisations avec l'api V5 de SONOS<br />					- Auto-découverte des équipements SONOS depuis le réseau (Ceci simplifie la configuration, il n'est plus necessaire de renseigner les ip et les adresses mac à la main)<br />					- Modification de la méthode d'envoi du TTS. L'envoi est maintenant plus rapide et plus fiable<br />					- Ajout d'un paramètre pour configurer le palier quand Sarah monte ou baisse le volume<br />					- Nettoyage du code pour plus de lisibilité. Le plugin fait maintenant appel à un module SonosAPI														</div>				<h1>V2</h1>				<div class="span3 well plugin-nav">					- Corrections de bugs majeurs (Topology des pièces) et mineurs <br />					- Synchronisation des pièces entres elle<br />					- Redirection des TTS<br />					- Nouvelle interface de configuration (disponible dans la page de documentation)				</div>				<h1>V1</h1>				<div class="span3 well plugin-nav">					- Initial Commit<br />					- Play / pause / prev / next (control your sonos)				</div>			</ul>		</div>	</div>	</body></html>